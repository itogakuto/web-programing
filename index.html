<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>たんぼメモ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* テーマ用CSS変数 */
    :root {
      --bg: #f5f7f9;
      --text: #333;
      --card-bg: #fff;
      --primary: #4CAF50;
      --primary-hover: #45a049;
      --shadow: rgba(0, 0, 0, 0.1);
      --theme: white;
      --heading: #446;
      --calendar-bg: #fff;
      --calendar-text: #333;
      --calendar-today: #29b6f6;
      --calendar-header: #446;
      --hero-img: url('image117.jpg');
    }
    [data-theme="dark"] {
      --bg: #181824;
      --text: #f3f3f3;
      --card-bg: #23243a;
      --primary: #5f4dee;
      --primary-hover: #4a39c7;
      --shadow: rgba(0, 0, 0, 0.4);
      --theme: #b3baff;
      --heading: #b3baff;
      --calendar-bg: #23243a;
      --calendar-text: #f3f3f3;
      --calendar-today: #5f4dee;
      --calendar-header: #b3baff;
      --hero-img: url('img_3245.jpg');
    }

    /* 全体の背景・文字色に適用 */
    body {
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }

    /* ボタンのスタイル */
    .theme-toggle {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 1000;
      padding: 10px 18px;
      background: rgba(238, 238, 238, 0.85);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #333;
      font-size: 1.3em;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: background 0.2s, box-shadow 0.2s;
    }
    .theme-toggle:hover {
      background: rgba(238, 238, 238, 1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }
    *, *::before, *::after { box-sizing: border-box; }
    .hero {
      width: 100%;
      min-height: 200px;
      background: var(--hero-img) center/cover no-repeat;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--theme);
      font-size: 2em;
      font-weight: bold;
      text-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .container { padding: 20px; }
    section {
      background: var(--card-bg);
      color: var(--text);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    h2 {
      color: var(--heading);
      margin-top: 0;
    }
    input[type="date"], input[type="text"], input[type="time"], select, textarea { width: 100%; padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
    textarea { resize: vertical; margin-bottom: 10px; }
    #photo-preview img { max-width: 100px; margin: 6px; display: inline-block; border-radius: 6px; }
    button { padding: 10px 16px; border: none; border-radius: 6px; background: #4CAF50; color: white; font-size: 1em; cursor: pointer; margin: 6px 6px 0 0; }
    button:hover { background: #45a049; }
    .cancel-btn { background: #bbb; }
    .cancel-btn:hover { background: #999; }
    ul { list-style: none; padding-left: 0; }
    li { margin-bottom: 10px; font-size: 1em; display: flex; align-items: center; }
    li.completed { text-decoration: line-through; color: #999; }
    .delete-btn { margin-left: auto; color: red; cursor: pointer; background: none; border: none; font-size: 1em; }
    .status-checkbox { margin-right: 8px; }
    .modal-bg { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 10; }
    .modal { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); width: 90%; max-width: 400px; }
    #camera-preview { display: none; width: 100%; max-width: 300px; margin-top: 10px; border-radius: 6px; }
    #calendar { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
    .calendar-day { padding: 10px; background: var(--calendar-bg); border-radius: 4px; text-align: center; cursor: pointer; }
    .calendar-day:hover { background: var(--primary); color: #fff; }
    .today { background: var(--calendar-today); color: #fff; }
    #calendar .calendar-day[style*='font-weight: bold'] {
      color: var(--calendar-header) !important;
      background: none !important;
    }
    #upcoming-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .card { background: #e3f2fd; padding: 10px; border-radius: 6px; }
    .popup { position: absolute; background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 20; }
    .edit-btn {
      background: #eee;
      border: 1px solid #bbb;
      border-radius: 6px;
      padding: 4px 10px;
      cursor: pointer;
      color: #333;
      margin-left: 8px;
      transition: background 0.2s;
    }
    .edit-btn:hover {
      background: #d1c4e9;
    }
  </style>
</head>
<body>
  <div class="hero">
    たんぼメモ
    <button class="theme-toggle" id="themeToggle">🌙</button>
  </div>
  <div class="container">
    <!-- 田植え日設定 -->
    <section>
      <h2>田植え日を設定</h2>
      <input type="date" id="planting-date">
      <button onclick="setPlantingDate()">設定</button>
    </section>

    <!-- 毎日の作業 -->
    <section>
      <h2>毎日の作業</h2>
      <ul id="routine-tasks">
        <li><input type="checkbox" id="cb-water"> 水位確認（設定してください）</li>
        <li><input type="checkbox"> 出口の水漏れチェック</li>
        <li><input type="checkbox"> 地面の露出確認</li>
        <li><input type="checkbox"> 葉の異常チェック（枯れ／変色／斑点）</li>
      </ul>
      <!-- 備考 -->
      <h3>備考（任意）</h3>
      <textarea id="remarks-text" rows="4" placeholder="今日の様子を記述..."></textarea>
      <div>
        <label for="remarks-photo" id="file-label" style="cursor:pointer;">画像を追加</label>
        <input type="file" id="remarks-photo" accept="image/*" style="display:none;">
        <button type="button" id="open-camera">カメラで撮影</button>
        <video id="camera-preview" autoplay playsinline></video>
        <button type="button" id="capture-btn" style="display:none;">撮影</button>
      </div>
      <div id="photo-preview"></div>
      <div style="margin-top:10px;">
        <button type="button" onclick="saveRemarks()">保存</button>
        <button type="button" class="cancel-btn" onclick="clearRemarks()">クリア</button>
      </div>
    </section>

    <!-- 今後の予定 -->
    <section>
      <h2>今後の予定</h2>
      <ul id="event-tasks"></ul>
      <button onclick="openModal()">予定を追加</button>
    </section>

    <!-- カレンダー -->
    <section>
      <h2>カレンダー</h2>
      <div id="upcoming-cards"></div>
      <div id="calendar"></div>
    </section>
  </div>

  <!-- 予定追加モーダル -->
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h3>予定の詳細</h3>
      <input type="text" id="event-text" placeholder="作業名">
      <input type="date" id="event-date">
      <input type="time" id="start-time">
      <input type="time" id="end-time">
      <select id="participants">
        <option value="">参加者を選択</option>
      </select>
      <input type="text" id="new-participant" placeholder="新しい参加者名">
      <button type="button" onclick="addParticipant()">＋追加</button>
      <div style="margin-top: 10px;">
        <button onclick="submitEvent()">確認</button>
        <button class="cancel-btn" onclick="closeModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <script>
    // localStorage keys
    const LS_PLANT = 'tanbo_plantingDate';
    const LS_REMARKS = 'tanbo_remarks';
    const LS_REMARKS_PHOTOS = 'tanbo_remarksPhotos';
    const LS_EVENTS = 'tanbo_events';

    // Load/set planting date
    function setPlantingDate() {
      const v = document.getElementById('planting-date').value;
      if (!v) return alert('田植え日を選んでください');
      localStorage.setItem(LS_PLANT, v);
      updateRoutineTasks();
    }
    function loadPlantingDate() {
      const v = localStorage.getItem(LS_PLANT);
      if (v) {
        document.getElementById('planting-date').value = v;
        updateRoutineTasks();
      }
    }
    // テーマ切替スクリプト
    const themeToggle = document.getElementById('themeToggle');

    function setTheme(theme) {
      document.body.setAttribute('data-theme', theme);
      localStorage.setItem('tanbo_theme', theme);
      themeToggle.textContent = theme === 'dark' ? '🌙' : '☀️';
    }

    themeToggle.addEventListener('click', () => {
      const current = document.body.getAttribute('data-theme');
      setTheme(current === 'light' ? 'dark' : 'light');
    });

    // ページ読み込み時に保存されたテーマを適用
    document.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('tanbo_theme') || 'light';
      setTheme(saved);
      // （ここで他の初期化処理を呼び出します）
    });

    // Remarks/photos
    const remarksText = document.getElementById('remarks-text');
    const remarksPhoto = document.getElementById('remarks-photo');
    const photoPreview = document.getElementById('photo-preview');
    const openCameraBtn = document.getElementById('open-camera');
    const video = document.getElementById('camera-preview');
    const captureBtn = document.getElementById('capture-btn');
    let stream; const MAX_IMAGES = 5;

    function loadRemarks() {
      const text = localStorage.getItem(LS_REMARKS);
      if (text) remarksText.value = text;
      const photos = JSON.parse(localStorage.getItem(LS_REMARKS_PHOTOS) || '[]');
      photos.forEach(src => appendPhoto(src));
    }
    function saveRemarks() {
      localStorage.setItem(LS_REMARKS, remarksText.value);
      const photos = Array.from(photoPreview.querySelectorAll('img')).map(img => img.src);
      localStorage.setItem(LS_REMARKS_PHOTOS, JSON.stringify(photos));
      alert('備考を保存しました');
    }
    function clearRemarks() {
      remarksText.value = ''; photoPreview.innerHTML = '';
      localStorage.removeItem(LS_REMARKS); localStorage.removeItem(LS_REMARKS_PHOTOS);
      resetPhotoControls();
    }
    function appendPhoto(src) {
      const img = document.createElement('img'); img.src = src; img.alt = '備考写真'; photoPreview.appendChild(img);
    }
    function resetPhotoControls() {
      document.getElementById('file-label').style.display = 'inline-block';
      openCameraBtn.disabled = false; video.style.display = 'none'; captureBtn.style.display = 'none';
      if (stream) stream.getTracks().forEach(t => t.stop());
    }
    remarksPhoto.addEventListener('change', e => {
      if (photoPreview.childElementCount >= MAX_IMAGES) return alert('画像は1日5枚までです');
      const file = e.target.files[0]; if (file) {
        const reader = new FileReader(); reader.onload = ev => { appendPhoto(ev.target.result); checkImageLimit(); };
        reader.readAsDataURL(file);
      }
    });
    openCameraBtn.addEventListener('click', async () => {
      if (photoPreview.childElementCount >= MAX_IMAGES) return alert('画像は1日5枚までです');
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
      video.srcObject = stream; video.style.display = 'block'; captureBtn.style.display = 'inline-block';
    });
    captureBtn.addEventListener('click', () => {
      const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      const dataUrl = canvas.toDataURL('image/png'); appendPhoto(dataUrl);
      checkImageLimit(); stream.getTracks().forEach(t=>t.stop()); video.style.display='none'; captureBtn.style.display='none';
    });
    function checkImageLimit() {
      if (photoPreview.childElementCount>=MAX_IMAGES) {
        document.getElementById('file-label').style.display='none'; openCameraBtn.disabled=true; captureBtn.style.display='none';
      }
    }

    // Events with status
    let eventTasks = [];
    const eventListEl = document.getElementById('event-tasks');
    function loadEvents() {
      eventTasks = JSON.parse(localStorage.getItem(LS_EVENTS) || '[]');
      eventTasks.forEach((ev, idx) => renderEvent(ev, idx));
    }
    function saveEvents() {
      localStorage.setItem(LS_EVENTS, JSON.stringify(eventTasks));
    }
    function addEventTask(task,date,start,end,participant) {
      const ev = { task,date,start,end,participant,completed:false };
      eventTasks.push(ev); saveEvents(); renderEvent(ev, eventTasks.length-1); renderCalendar();
    }
    function renderEvent(ev, idx) {
      const li = document.createElement('li');
      const checkbox = document.createElement('input');
      checkbox.type='checkbox'; checkbox.className='status-checkbox';
      checkbox.checked = ev.completed;
      checkbox.addEventListener('change', () => toggleEventStatus(idx, li));
      li.appendChild(checkbox);
      const text = document.createTextNode(`🕒 ${ev.start}〜${ev.end} ｜ 👥 ${ev.participant} ｜ ${ev.task}（${ev.date}）`);
      li.appendChild(text);
      if (ev.completed) li.classList.add('completed');
      const btn = document.createElement('button'); btn.textContent='削除'; btn.className='delete-btn';
      btn.onclick = () => deleteEvent(idx, li);
      li.appendChild(btn);
      // 編集ボタンを追加
      const editBtn = document.createElement('button');
      editBtn.className = 'edit-btn';
      editBtn.textContent = '✏️';
      editBtn.onclick = () => openEditEventModal(idx);
      li.appendChild(editBtn);
      eventListEl.appendChild(li);
    }

    // グローバル参加者リスト
    let globalParticipants = [];
    // 初期化時に既存のselectから取得
    function initGlobalParticipants() {
      globalParticipants = Array.from(document.getElementById('participants').options)
        .map(opt => opt.value).filter(v => v);
    }
    // 編集用の関数（参加者のみ編集可能）
    function openEditEventModal(idx) {
      const ev = eventTasks[idx];
      // このイベントの参加者配列
      let selectedParticipants = ev.participant.split(',').map(x=>x.trim()).filter(x=>x);
      // モーダル生成
      const modalBg = document.createElement('div');
      modalBg.className = 'modal-bg';
      modalBg.style.display = 'flex';
      function renderParticipantsSelect() {
        // 選択肢描画
        const select = modalBg.querySelector('#edit-participants');
        select.innerHTML = globalParticipants.map(name =>
          `<option value="${name}" ${selectedParticipants.includes(name)?'selected':''}>${name}</option>`
        ).join('');
        // 選択中の参加者タグ＋削除ボタン
        const delArea = modalBg.querySelector('#edit-participant-delete-area');
        delArea.innerHTML = selectedParticipants.map((name, idx) =>
          `<span style='display:inline-block;margin:2px 6px 2px 0;padding:2px 6px;background:#eee;border-radius:4px;'>${name} <button type='button' class='del-participant-btn' data-idx='${idx}' style='border:none;background:none;cursor:pointer;font-size:1em;'>🗑️</button></span>`
        ).join('');
        // 削除ボタンにイベント
        delArea.querySelectorAll('.del-participant-btn').forEach(btn => {
          btn.onclick = function() {
            const i = Number(btn.getAttribute('data-idx'));
            selectedParticipants.splice(i, 1);
            renderParticipantsSelect();
          };
        });
      }
      modalBg.innerHTML = `
        <div class="modal">
          <h3>参加者を編集</h3>
          <div id="edit-participant-delete-area" style="margin-bottom:8px;"></div>
          <select id="edit-participants" multiple size="5" style="width:100%;margin-bottom:12px;"></select>
          <input type="text" id="edit-new-participant" placeholder="新しい参加者名" style="width:100%;margin-bottom:8px;">
          <button type="button" id="edit-add-participant">＋追加</button>
          <div style="margin-top: 10px;">
            <button id="edit-save">保存</button>
            <button class="cancel-btn" id="edit-cancel">キャンセル</button>
          </div>
        </div>
      `;
      document.body.appendChild(modalBg);
      renderParticipantsSelect();
      // 追加ボタン
      modalBg.querySelector('#edit-add-participant').onclick = function() {
        const input = modalBg.querySelector('#edit-new-participant');
        const name = input.value.trim();
        if (name && !globalParticipants.includes(name)) {
          globalParticipants.push(name);
        }
        if (name && !selectedParticipants.includes(name)) {
          selectedParticipants.push(name);
        }
        renderParticipantsSelect();
        // 追加した人を選択状態に
        const select = modalBg.querySelector('#edit-participants');
        for (let opt of select.options) {
          if (opt.value === name) { opt.selected = true; break; }
        }
        input.value = '';
      };
      // selectの選択変更でselectedParticipantsを更新
      modalBg.querySelector('#edit-participants').onchange = function(e) {
        selectedParticipants = Array.from(e.target.selectedOptions).map(opt => opt.value);
        renderParticipantsSelect();
      };
      // 保存ボタン
      modalBg.querySelector('#edit-save').onclick = function() {
        ev.participant = selectedParticipants.join(', ');
        // 全体リストも更新
        const selectEl = document.getElementById('participants');
        selectEl.innerHTML = '<option value="">参加者を選択</option>' + globalParticipants.map(name => `<option value="${name}">${name}</option>`).join('');
        saveEvents();
        eventListEl.innerHTML = '';
        eventTasks.forEach((ev, i) => renderEvent(ev, i));
        modalBg.remove();
      };
      // キャンセルボタン
      modalBg.querySelector('#edit-cancel').onclick = function() {
        modalBg.remove();
      };
    }

    function toggleEventStatus(idx, li) {
      eventTasks[idx].completed = !eventTasks[idx].completed;
      saveEvents();
      if (eventTasks[idx].completed) li.classList.add('completed'); else li.classList.remove('completed');
    }
    function deleteEvent(idx, li) {
      eventTasks.splice(idx,1); saveEvents(); li.remove(); renderCalendar();
      eventListEl.innerHTML=''; eventTasks.forEach((ev,i)=>renderEvent(ev,i));
    }

    // Modal
    function openModal(){ document.getElementById('modalBg').style.display='flex'; }
    function closeModal(){ document.getElementById('modalBg').style.display='none'; }
    function submitEvent(){
      const t = document.getElementById('event-text').value.trim();
      const d = document.getElementById('event-date').value;
      const s = document.getElementById('start-time').value;
      const e = document.getElementById('end-time').value;
      const p = document.getElementById('participants').value;
      if (t&&d&&s&&e&&p) { addEventTask(t,d,s,e,p); closeModal(); }
      else alert('すべての項目を入力してください');
    }
    function addParticipant(){ const input=document.getElementById('new-participant'); const name=input.value.trim();
      if(name){ const opt=document.createElement('option'); opt.value=name; opt.textContent=name;
        document.getElementById('participants').appendChild(opt); input.value=''; }
    }

    // Calendar
    function renderCalendar(){
      const cal = document.getElementById('calendar'); cal.innerHTML = '';
      const today = new Date(), y=today.getFullYear(), m=today.getMonth();
      const first=new Date(y,m,1).getDay(), days=new Date(y,m+1,0).getDate();
      ['日','月','火','水','木','金','土'].forEach(d=>{
        const hd=document.createElement('div'); hd.textContent=d; hd.className='calendar-day'; hd.style.fontWeight='bold'; cal.appendChild(hd);
      });
      for(let i=0;i<first;i++) cal.appendChild(document.createElement('div'));
      for(let d=1;d<=days;d++){ const dateStr=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const el=document.createElement('div'); el.textContent=d; el.className='calendar-day';
        if(d===today.getDate()) el.classList.add('today');
        el.addEventListener('click',e=>showDayPopup(e,dateStr)); cal.appendChild(el);
      }
      renderUpcoming();
    }
    function renderUpcoming(){ const up=document.getElementById('upcoming-cards'); up.innerHTML='';
      const now=new Date(); eventTasks.forEach(ev=>{ const dt=new Date(ev.date);
        const diff=(dt-now)/(1000*60*60*24); if(diff>=0&&diff<7){ const c=document.createElement('div'); c.className='card';
          c.textContent=`${ev.date} ${ev.start}〜${ev.end} ${ev.task}`; up.appendChild(c); }
      }); }
    function showDayPopup(e,date){ document.querySelectorAll('.popup').forEach(p=>p.remove());
      const pop=document.createElement('div'); pop.className='popup'; const tasks=eventTasks.filter(ev=>ev.date===date);
      if(tasks.length===0) pop.textContent='予定なし'; else tasks.forEach(ev=>{ const p=document.createElement('p'); p.textContent=`${ev.start}〜${ev.end} ${ev.task}`; pop.appendChild(p); });
      document.body.appendChild(pop); const r=e.target.getBoundingClientRect(); pop.style.top=`${r.top-pop.offsetHeight-10}px`; pop.style.left=`${r.left}px`;
      setTimeout(()=>pop.remove(),5000);
    }

    // Routine status
    function updateRoutineTasks(){
      const v=localStorage.getItem(LS_PLANT); if(!v) return;
      const pd=new Date(v), now=new Date(); const diff=Math.floor((now-pd)/(1000*60*60*24)); let txt='';
      if(diff<0) txt='未定義（未来）'; else if(diff<=5) txt='2〜3cm'; else if(diff<=14) txt='3〜5cm'; else txt='管理者判断';
      document.getElementById('cb-water').nextSibling.textContent=` 水位確認（${txt}）`;
    }

    // Init
    document.addEventListener('DOMContentLoaded',()=>{
      loadPlantingDate(); loadRemarks(); loadEvents(); renderCalendar();
      initGlobalParticipants(); // 初期化時にグローバル参加者リストをセット
    });

  </script>
</body>
</html>
