<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãŸã‚“ã¼ãƒ¡ãƒ¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: sans-serif; background: #f5f7f9; margin: 0; padding: 0; color: #333; }
    .hero { width: 100%; min-height: 200px; background: url('image117.jpg') center/cover no-repeat; display: flex; align-items: center; justify-content: center; color: white; font-size: 2em; font-weight: bold; text-shadow: 0 2px 8px rgba(0,0,0,0.4); }
    .container { padding: 20px; }
    section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h2 { margin-top: 0; color: #446; }
    input[type="date"], input[type="text"], input[type="time"], select, textarea { width: 100%; padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 1em; }
    textarea { resize: vertical; margin-bottom: 10px; }
    #photo-preview img { max-width: 100px; margin: 6px; display: inline-block; border-radius: 6px; }
    button { padding: 10px 16px; border: none; border-radius: 6px; background: #4CAF50; color: white; font-size: 1em; cursor: pointer; margin: 6px 6px 0 0; }
    button:hover { background: #45a049; }
    .cancel-btn { background: #bbb; }
    .cancel-btn:hover { background: #999; }
    ul { list-style: none; padding-left: 0; }
    li { margin-bottom: 10px; font-size: 1em; }
    .delete-btn { margin-left: 10px; color: red; cursor: pointer; background: none; border: none; font-size: 1em; }
    .modal-bg { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 10; }
    .modal { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.2); width: 90%; max-width: 400px; }
    #camera-preview { display: none; width: 100%; max-width: 300px; margin-top: 10px; border-radius: 6px; }
    #calendar { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; }
    .calendar-day { padding: 10px; background: #fff; border-radius: 4px; text-align: center; cursor: pointer; }
    .calendar-day:hover { background: #e0f7fa; }
    .today { background: #29b6f6; color: #fff; }
    #upcoming-cards { display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px; }
    .card { background: #e3f2fd; padding: 10px; border-radius: 6px; }
    .popup { position: absolute; background: #fff; border: 1px solid #ccc; padding: 10px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 20; }
  </style>
</head>
<body>
  <div class="hero">ãŸã‚“ã¼ãƒ¡ãƒ¢</div>
  <div class="container">
    <section>
      <h2>ç”°æ¤ãˆæ—¥ã‚’è¨­å®š</h2>
      <input type="date" id="planting-date">
      <button onclick="setPlantingDate()">è¨­å®š</button>
    </section>
    <section>
      <h2>æ¯æ—¥ã®ä½œæ¥­</h2>
      <ul id="routine-tasks">
        <li><input type="checkbox" id="cb-water"> æ°´ä½ç¢ºèªï¼ˆè¨­å®šã—ã¦ãã ã•ã„ï¼‰</li>
        <li><input type="checkbox"> å‡ºå£ã®æ°´æ¼ã‚Œãƒã‚§ãƒƒã‚¯</li>
        <li><input type="checkbox"> åœ°é¢ã®éœ²å‡ºç¢ºèª</li>
        <li><input type="checkbox"> è‘‰ã®ç•°å¸¸ãƒã‚§ãƒƒã‚¯ï¼ˆæ¯ã‚Œï¼å¤‰è‰²ï¼æ–‘ç‚¹ï¼‰</li>
      </ul>
      <h3>å‚™è€ƒï¼ˆä»»æ„ï¼‰</h3>
      <textarea id="remarks-text" rows="4" placeholder="ä»Šæ—¥ã®æ§˜å­ã‚’è¨˜è¿°..."></textarea>
      <div>
        <label for="remarks-photo" id="file-label" style="cursor:pointer;">ç”»åƒã‚’è¿½åŠ </label>
        <input type="file" id="remarks-photo" accept="image/*" style="display:none;">
        <button type="button" id="open-camera">ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
        <video id="camera-preview" autoplay playsinline></video>
        <button type="button" id="capture-btn" style="display:none;">æ’®å½±</button>
      </div>
      <div id="photo-preview"></div>
      <div style="margin-top:10px;">
        <button type="button" onclick="saveRemarks()">ä¿å­˜</button>
        <button type="button" class="cancel-btn" onclick="clearRemarks()">ã‚¯ãƒªã‚¢</button>
      </div>
    </section>
    <section>
      <h2>ä»Šå¾Œã®äºˆå®š</h2>
      <ul id="event-tasks"></ul>
      <button onclick="openModal()">äºˆå®šã‚’è¿½åŠ </button>
    </section>
    <section>
      <h2>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
      <div id="upcoming-cards"></div>
      <div id="calendar"></div>
    </section>
  </div>
  <div class="modal-bg" id="modalBg">
    <div class="modal">
      <h3>äºˆå®šã®è©³ç´°</h3>
      <input type="text" id="event-text" placeholder="ä½œæ¥­å">
      <input type="date" id="event-date">
      <input type="time" id="start-time">
      <input type="time" id="end-time">
      <select id="participants">
        <option value="">å‚åŠ è€…ã‚’é¸æŠ</option>
      </select>
      <input type="text" id="new-participant" placeholder="æ–°ã—ã„å‚åŠ è€…å">
      <button type="button" onclick="addParticipant()">ï¼‹è¿½åŠ </button>
      <div style="margin-top: 10px;">
        <button onclick="submitEvent()">ç¢ºèª</button>
        <button class="cancel-btn" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  <script>
    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã‚­ãƒ¼å®šç¾©
    const LS_PLANT = 'tanbo_plantingDate';
    const LS_REMARKS = 'tanbo_remarks';
    const LS_REMARKS_PHOTOS = 'tanbo_remarksPhotos';
    const LS_EVENTS = 'tanbo_events';

    // Planting date
    function setPlantingDate() {
      const inp = document.getElementById('planting-date');
      const v = inp.value;
      if (!v) return alert('ç”°æ¤ãˆæ—¥ã‚’é¸ã‚“ã§ãã ã•ã„');
      localStorage.setItem(LS_PLANT, v);
      updateRoutineTasks();
    }
    function loadPlantingDate() {
      const v = localStorage.getItem(LS_PLANT);
      if (v) {
        document.getElementById('planting-date').value = v;
        updateRoutineTasks();
      }
    }

    // Remarks and photos
    const remarksText = document.getElementById('remarks-text');
    const remarksPhoto = document.getElementById('remarks-photo');
    const photoPreview = document.getElementById('photo-preview');
    const openCameraBtn = document.getElementById('open-camera');
    const video = document.getElementById('camera-preview');
    const captureBtn = document.getElementById('capture-btn');
    let stream;
    const MAX_IMAGES = 5;

    function loadRemarks() {
      const text = localStorage.getItem(LS_REMARKS);
      if (text) remarksText.value = text;
      const photos = JSON.parse(localStorage.getItem(LS_REMARKS_PHOTOS) || '[]');
      photos.forEach(src => appendPhoto(src));
    }
    function saveRemarks() {
      localStorage.setItem(LS_REMARKS, remarksText.value);
      const photos = Array.from(photoPreview.querySelectorAll('img')).map(img => img.src);
      localStorage.setItem(LS_REMARKS_PHOTOS, JSON.stringify(photos));
      alert('å‚™è€ƒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    }
    function clearRemarks() {
      remarksText.value = '';
      photoPreview.innerHTML = '';
      localStorage.removeItem(LS_REMARKS);
      localStorage.removeItem(LS_REMARKS_PHOTOS);
      resetPhotoControls();
    }
    function appendPhoto(src) {
      const img = document.createElement('img'); img.src = src; img.alt = 'å‚™è€ƒå†™çœŸ';
      photoPreview.appendChild(img);
    }
    function resetPhotoControls() {
      document.getElementById('file-label').style.display = 'inline-block';
      openCameraBtn.disabled = false;
      video.style.display = 'none'; captureBtn.style.display = 'none';
      if (stream) stream.getTracks().forEach(t => t.stop());
    }

    // Attach events
    remarksPhoto.addEventListener('change', e => {
      if (photoPreview.childElementCount >= MAX_IMAGES) return alert('ç”»åƒã¯1æ—¥5æšã¾ã§ã§ã™');
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = ev => { appendPhoto(ev.target.result); checkImageLimit(); };
        reader.readAsDataURL(file);
      }
    });
    openCameraBtn.addEventListener('click', async () => {
      if (photoPreview.childElementCount >= MAX_IMAGES) return alert('ç”»åƒã¯1æ—¥5æšã¾ã§ã§ã™');
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } } });
      video.srcObject = stream; video.style.display = 'block'; captureBtn.style.display = 'inline-block';
    });
    captureBtn.addEventListener('click', () => {
      const canvas = document.createElement('canvas'); canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/png'); appendPhoto(dataUrl);
      checkImageLimit(); stream.getTracks().forEach(t => t.stop()); video.style.display = 'none'; captureBtn.style.display = 'none';
    });
    function checkImageLimit() {
      if (photoPreview.childElementCount >= MAX_IMAGES) {
        document.getElementById('file-label').style.display = 'none'; openCameraBtn.disabled = true; captureBtn.style.display = 'none';
      }
    }

    // Events
    let eventTasks = [];
    const eventListEl = document.getElementById('event-tasks');
    function loadEvents() {
      eventTasks = JSON.parse(localStorage.getItem(LS_EVENTS) || '[]');
      eventTasks.forEach(ev => renderEvent(ev));
    }
    function saveEvents() {
      localStorage.setItem(LS_EVENTS, JSON.stringify(eventTasks));
    }
    function addEventTask(task, date, start, end, participant) {
      const ev = { task, date, start, end, participant };
      eventTasks.push(ev); saveEvents(); renderEvent(ev); renderCalendar();
    }
    function renderEvent(ev) {
      const li = document.createElement('li');
      li.textContent = `ğŸ•’ ${ev.start}ã€œ${ev.end} ï½œ ğŸ‘¥ ${ev.participant} ï½œ ${ev.task}ï¼ˆ${ev.date}ï¼‰`;
      const btn = document.createElement('button'); btn.textContent = 'å‰Šé™¤'; btn.className='delete-btn';
      btn.onclick = () => { deleteEvent(ev, li); };
      li.appendChild(btn); eventListEl.appendChild(li);
    }
    function deleteEvent(ev, li) {
      eventTasks = eventTasks.filter(e => e !== ev);
      saveEvents(); li.remove(); renderCalendar();
    }

    // Modal
    function openModal() { document.getElementById('modalBg').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalBg').style.display = 'none'; }
    function submitEvent() {
      const t = document.getElementById('event-text').value.trim();
      const d = document.getElementById('event-date').value;
      const s = document.getElementById('start-time').value;
      const e = document.getElementById('end-time').value;
      const p = document.getElementById('participants').value;
      if (t && d && s && e && p) { addEventTask(t, d, s, e, p); closeModal(); }
      else alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    }
    function addParticipant() {
      const input = document.getElementById('new-participant'); const name = input.value.trim();
      if (name) {
        const opt = document.createElement('option'); opt.value = name; opt.textContent = name;
        document.getElementById('participants').appendChild(opt); input.value = '';
      }
    }

    // Calendar
    function renderCalendar() {
      const cal = document.getElementById('calendar'); cal.innerHTML = '';
      const today = new Date(), y = today.getFullYear(), m = today.getMonth();
      const first = new Date(y, m, 1).getDay(); const days = new Date(y, m+1, 0).getDate();
      ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(d => {
        const hd = document.createElement('div'); hd.textContent = d; hd.className='calendar-day'; hd.style.fontWeight='bold'; cal.appendChild(hd);
      });
      for (let i=0; i<first; i++) cal.appendChild(document.createElement('div'));
      for (let d=1; d<=days; d++) {
        const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const el = document.createElement('div'); el.textContent = d; el.className='calendar-day';
        if (d === today.getDate()) el.classList.add('today');
        el.addEventListener('click', e => showDayPopup(e, dateStr)); cal.appendChild(el);
      }
      renderUpcoming();
    }
    function renderUpcoming() {
      const up = document.getElementById('upcoming-cards'); up.innerHTML = '';
      const now = new Date();
      eventTasks.forEach(ev => {
        const dt = new Date(ev.date);
        const diff = (dt - now) / (1000*60*60*24);
        if (diff >= 0 && diff < 7) {
          const c = document.createElement('div'); c.className = 'card';
          c.textContent = `${ev.date} ${ev.start}ã€œ${ev.end} ${ev.task}`;
          up.appendChild(c);
        }
      });
    }
    function showDayPopup(e, date) {
      document.querySelectorAll('.popup').forEach(p => p.remove());
      const pop = document.createElement('div'); pop.className = 'popup';
      const tasks = eventTasks.filter(ev => ev.date === date);
      if (tasks.length === 0) pop.textContent = 'äºˆå®šãªã—';
      else tasks.forEach(ev => {
        const p = document.createElement('p'); p.textContent = `${ev.start}ã€œ${ev.end} ${ev.task}`;
        pop.appendChild(p);
      });
      document.body.appendChild(pop);
      const r = e.target.getBoundingClientRect();
      pop.style.top = `${r.top - pop.offsetHeight - 10}px`;
      pop.style.left = `${r.left}px`;
      setTimeout(() => pop.remove(), 5000);
    }

    // Routine water checkbox
    function updateRoutineTasks() {
      const v = localStorage.getItem(LS_PLANT);
      if (!v) return;
      const pd = new Date(v), now = new Date();
      const diff = Math.floor((now - pd) / (1000*60*60*24));
      let txt = '';
      if (diff < 0) txt = 'æœªå®šç¾©ï¼ˆæœªæ¥ã®æ—¥ä»˜ã§ã™ï¼‰';
      else if (diff <= 5) txt = '2ã€œ3cmï¼ˆç”°æ¤ãˆã€œ5æ—¥ç›®ï¼‰';
      else if (diff <= 14) txt = '3ã€œ5cmï¼ˆ5æ—¥ç›®ã€œ2é€±é–“ï¼‰';
      else txt = 'ç®¡ç†è€…åˆ¤æ–­ï¼ˆæˆé•·é€²è¡Œä¸­ï¼‰';
      document.getElementById('cb-water').nextSibling.textContent = ` æ°´ä½ç¢ºèªï¼ˆ${txt}ï¼‰`;
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      loadPlantingDate();
      loadRemarks();
      loadEvents();
      renderCalendar();
    });
  </script>
</body>
</html>
